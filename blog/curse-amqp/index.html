<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://nmacun.com/ name=base><title>nurulmac11's blog • Curse of AMQP: Celery</title><link href=https://nmacun.com/favicon.png rel=icon type=image/png><link title="nurulmac11's blog - Atom Feed" href=https://nmacun.com/atom.xml rel=alternate type=application/atom+xml><link href="https://nmacun.com/custom_subset.css?h=753f2b519893883e57d5" rel=stylesheet><link href="https://nmacun.com/main.css?h=03cee7c5880a245ffa82" rel=stylesheet><link href="https://nmacun.com/custom.css?h=503a89758b64cec1a3f5" rel=stylesheet><link href="https://nmacun.com/skins/evangelion.css?h=191505807c4f09b9cc7e" rel=stylesheet><meta content="light dark" name=color-scheme><meta content="How to solve annoying problems with celery." name=description><meta content="How to solve annoying problems with celery." property=og:description><meta content="index, nofollow" name=robots><meta content="Curse of AMQP: Celery" property=og:title><meta content=article property=og:type><meta content=en_GB property=og:locale:alternate><link href=https://nmacun.com/blog/curse-amqp/ hreflang=en rel=alternate><meta content=https://nmacun.com/blog/curse-amqp/ property=og:url><meta content="nurulmac11's blog" property=og:site_name><noscript><link href=https://nmacun.com/no_js.css rel=stylesheet></noscript><script src=https://nmacun.com/js/initializeTheme.min.js></script><script defer src=https://nmacun.com/js/themeSwitcher.min.js></script><script async data-goatcounter=https://nurulmac11.goatcounter.com/count src=https://gc.zgo.at/count.js></script><script src="https://www.googletagmanager.com/gtag/js?id=G-X7VT1SY2WY" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[];gtag(`js`,new Date());gtag(`config`,`G-X7VT1SY2WY`)</script><script src="https://nmacun.com/js/searchElasticlunr.min.js?h=9b8cf8d81ad8868d3e54" defer></script><body><header><nav class=navbar><div class=nav-title><a class=home-title href=https://nmacun.com>nurulmac11's blog</a><br><span class=home-description>not all those who wander are lost</span></div><div class=nav-navs><ul><li><a class="nav-links no-hover-padding" href=https://nmacun.com/blog/> blog </a><li><a class="nav-links no-hover-padding" href=https://nmacun.com/about/> about </a><li><a class="nav-links no-hover-padding" href=https://nmacun.com/archive/> archive </a><li class=js><div aria-label="Click or press $SHORTCUT to open search" class="search-icon interactive-icon" title="Click or press $SHORTCUT to open search" id=search-button role=button tabindex=0><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg></div><li class=language-switcher>| <span class=lang-item> en </span><span class=lang-item><a aria-label=Türkçe href=https://nmacun.com//tr/blog/curse-amqp/ lang=tr role=menuitem>tr </a> </span>|<li class="theme-switcher-wrapper js"><div aria-label="Toggle dark mode" title="Toggle dark/light mode" aria-pressed=false class=theme-switcher role=button tabindex=0></div><div aria-label="Reset mode to default" title="Reset mode to default" aria-hidden=true class=theme-resetter role=button tabindex=0></div></ul></div></nav></header><div class=content><main><article><h1 class=article-title>Curse of AMQP: Celery</h1><ul class=meta><li>30th Oct 2023</li> • <li title="521 words">3 min read</li> • <li>Tags: <li><a href=https://nmacun.com/tags/celery/>celery</a>, <li><a href=https://nmacun.com/tags/eta/>eta</a>, <li><a href=https://nmacun.com/tags/sqs/>sqs</a>, <li><a href=https://nmacun.com/tags/eta/>eta</a>, <li><a href=https://nmacun.com/tags/retry/>retry</a></ul><section class=body><blockquote><p>Nobody panics when things go “according to plan.” Even if the plan is horrifying!</blockquote><p>If you haven’t had a problem with celery yet, most likely, you haven’t used it enough. In this post, I will explain problems that I’ve encountered and solutions I finally found after struggling for days.</p><span id=continue-reading></span><p>TLDR:<ul><li>For a low workload of a few processes per minute, stick with default thread pooling for your workers.<li>If you’re dealing with high throughput (thousands of processes per minute), opt for eventlet pooling.<li>Avoid using gevent.<li>When facing memory issues, ensure there are no unhandled exceptions within your tasks and task methods return only True, also, don’t use exc parameter within retry calls.</ul><hr><p>This was our celery config and command to start workers within fastapi project;<pre class="language-python z-code" data-lang=python><code class=language-python data-lang=python><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">app</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">Celery</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">    <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">tasks<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">    <span class="z-variable z-parameter z-python">broker</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">os</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">getenv</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">CELERY_BROKER<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">redis://redis<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">    <span class="z-variable z-parameter z-python">broker_connection_retry</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-constant z-language z-python">True</span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">    <span class="z-variable z-parameter z-python">broker_connection_max_retries</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-constant z-language z-python">None</span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">    <span class="z-variable z-parameter z-python">broker_connection_timeout</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-constant z-numeric z-integer z-decimal z-python">60</span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">    <span class="z-variable z-parameter z-python">result_backend</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">os</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">getenv</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">CELERY_RESULT_BACKEND<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-separator z-arguments z-python">,</span> <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">db+postgresql://admin:admin@192.168.1.1:5432/example-db<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python">    <span class="z-variable z-parameter z-python">task_soft_time_limit</span><span class="z-keyword z-operator z-assignment z-python">=</span><span class="z-constant z-numeric z-integer z-decimal z-python">3</span><span class="z-punctuation z-separator z-arguments z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">app</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">conf</span><span class="z-punctuation z-accessor z-dot z-python">.</span><span class="z-meta z-generic-name z-python">broker_transport_options</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-mapping-or-set z-python"><span class="z-punctuation z-section z-mapping-or-set z-begin z-python">{</span>
</span></span><span class="z-source z-python"><span class="z-meta z-mapping-or-set z-python"></span><span class="z-meta z-mapping z-python">    </span><span class="z-meta z-mapping z-key z-python"><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python">visibility_timeout<span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span></span><span class="z-meta z-mapping z-python"><span class="z-punctuation z-separator z-mapping z-key-value z-python">:</span></span><span class="z-meta z-mapping z-python"> </span><span class="z-meta z-mapping z-value z-python"><span class="z-constant z-numeric z-integer z-decimal z-python">12</span> <span class="z-keyword z-operator z-arithmetic z-python">*</span> <span class="z-constant z-numeric z-integer z-decimal z-python">3600</span></span><span class="z-meta z-mapping z-python"><span class="z-punctuation z-separator z-mapping z-python">,</span>
</span></span><span class="z-source z-python"><span class="z-meta z-mapping z-python"><span class="z-punctuation z-section z-mapping z-end z-python">}</span></span>
</span></code></pre><pre class="language-shell z-code" data-lang=shell><code class=language-shell data-lang=shell><span class="z-text z-plain">celery -A src.tasks worker -n hp@Billing-Manager --pool=gevent --concurrency=100 -Q hp -l INFO &
</span></code></pre><p>Pretty simple and straightforward actually. We have redis as a broker on the same network and postgresql db for storing results of tasks. Also we are using ETA and retry features of celery which makes things more complex and hard. But we keep having mysterious problems with celery. What’s happening was, our workers were stopping to process tasks suddenly, after working several hours, without any error. When we check the logs, status of the server, network, everything seemed ok. I even tried switching in between redis and rabbitmq as broker several times, but didn’t help at all.<p>There were <a href=https://stackoverflow.com/a/33936673/4087794 target=_blank>some debugging suggestions</a> on the internet using tools such as strace but they lead to nothing. My best guess was it was caused some kind of deadlock or connection problem with broker. Seemed like celery was losing connection to broker but was unable to reconnect to broker. I found some discussions on celery/kombu repo’s discussion pages but there were no solution, just some unclosed pull requests that still needs work.<hr><pre class="language-shell z-code" data-lang=shell><code class=language-shell data-lang=shell><span class="z-text z-plain">celery -A src.tasks worker -n hp@Billing-Manager --concurrency=20 -Q hp -l INFO &
</span></code></pre><p>Then I started to try different methods. Firstly, I tried to switch just thread pooling. We were using gevent, which is using green threads, which allows you to use hundreds of thread compared to the default thread pooling but as expected it was working very slow and we were having oom(out of memory) issues.<pre class="language-shell z-code" data-lang=shell><code class=language-shell data-lang=shell><span class="z-text z-plain">celery -A src.tasks worker -n 'hp@Billing-Manager' --pool=eventlet --concurrency=100 -Q hp -l INFO &
</span></code></pre><p>Then I found another pooling method, which was eventlet. It’s very similar to gevent, I am still not sure what’s the difference exactly but it seems like they are using different libraries underneath them. If you want to read more about this, you can <a href=https://blog.gevent.org/2010/02/27/why-gevent/ target=_blank>check this link</a>.<p>This was working much better compared to the alternatives but it was filling memory just within minutes. After checking task methods, I cleared all unhandled exceptions and return values. Also removed exc parameter from self.retry calls. Even we had a database for storing results, it seems like celery was unable to clear these from memory or it was happening because our tasks were retried all day several times. But this memory issue also solved after this update. Now, it works flawlessly.<p>That was all. Hope that works for you too. Reach me out via linkedin if you have any questions.</section><nav class="full-width article-navigation"><div><a aria-describedby=left_title aria-label=Next href=https://nmacun.com/blog/wellness-food/><span class=arrow>←</span> Next</a><p aria-hidden=true id=left_title>A Journey to Wellness: Food</div><div><a aria-describedby=right_title aria-label=Prev href=https://nmacun.com/blog/ssl-settings/>Prev <span class=arrow>→</span></a><p aria-hidden=true id=right_title>Setting SSL for Custom Subdomain on Google App Engine</div></nav><div class=comments data-category=Announcements data-category-id=DIC_kwDOMq0lcM4CiGtK data-dark-theme=noborder_dark data-input-position=bottom data-lang=en data-lazy-loading=true data-light-theme=noborder_light data-mapping=specific data-reactions-enabled=1 data-repo=nurulmac11/nmacun-giscus data-repo-id=R_kgDOMq0lcA data-strict=1 data-term=curse-amqp id=comments><script async src=https://nmacun.com/js/giscus.min.js></script><noscript>You need JavaScript to view the comments.</noscript></div></article></main><div id=button-container><a title="Go to the comments section" class=no-hover-padding href=#comments id=comments-button> <svg viewbox="0 0 20 20" fill=currentColor><path d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule=evenodd fill-rule=evenodd /></svg> </a><a title="Go to the top of the page" class=no-hover-padding href=# id=top-button> <svg viewbox="0 0 20 20" fill=currentColor><path d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z"/></svg> </a></div><span class=hidden id=copy-success> Copied! </span><span class=hidden id=copy-init> Copy code to clipboard </span><script defer src=https://nmacun.com/js/copyCodeToClipboard.min.js></script></div><footer><section><nav class="socials nav-navs"><ul><li><a class="nav-links no-hover-padding social no-icon" href=https://nmacun.com/atom.xml rel=noopener target=_blank> <img alt=feed src=https://nmacun.com/social_icons/rss.svg title=feed> </a><li class=js><a class="nav-links no-hover-padding social" data-encoded-email=bnVydWxsYWgyMDFAZ21haWwuY29t href=#><img alt=email src=https://nmacun.com/social_icons/email.svg title=email> </a><li><a class="nav-links no-hover-padding social no-icon" rel="noopener me" href=https://github.com/nurulmac11 target=_blank> <img alt=github src=https://nmacun.com/social_icons/github.svg title=github> </a><li><a class="nav-links no-hover-padding social no-icon" rel="noopener me" href=https://www.instagram.com/nrlmcn/ target=_blank> <img alt=instagram src=https://nmacun.com/social_icons/instagram.svg title=instagram> </a><li><a class="nav-links no-hover-padding social no-icon" rel="noopener me" href=https://www.linkedin.com/in/nrlmcn/ target=_blank> <img alt=linkedin src=https://nmacun.com/social_icons/linkedin.svg title=linkedin> </a></ul></nav><nav class=nav-navs><small> <ul><li><a class="nav-links no-hover-padding" href=https://nmacun.com/privacy/> privacy policy </a><li><a class="nav-links no-hover-padding" href=https://nmacun.com/sitemap.xml> sitemap </a></ul> </small></nav><div class=credits><small> <p><p>nurulmac11’s blog © 2024 nurulmac11 • Unless otherwise noted, the content in this website is available under the <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ rel=noopener target=_blank>CC BY-NC-SA 4.0</a> license.</p> Powered by <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> & <a href=https://github.com/welpo/tabi rel=noopener target=_blank>tabi</a> • <a href=https://github.com/nurulmac11/nmacun rel=noopener target=_blank> Site source </a></small></div></section><script async src=https://nmacun.com/js/decodeMail.min.js></script><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><h1 class=visually-hidden id=modalTitle>Search</h1><div id=modal-content><div id=searchBar><div aria-hidden=true class=search-icon><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg></div><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search… role=combobox spellcheck=false><div class="close-icon interactive-icon" title="Clear search" id=clear-search role=button tabindex=0><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></div></div><div id=results-container><div id=results-info><span id=zero_results> No results</span><span id=one_results> $NUMBER result</span><span id=many_results> $NUMBER results</span><span id=two_results> $NUMBER results</span><span id=few_results> $NUMBER results</span></div><div id=results role=listbox></div></div></div></div></footer>